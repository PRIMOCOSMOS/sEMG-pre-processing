# sEMG预处理工具包使用指南

本指南提供详细的中文使用说明。

## 快速开始

### 1. 安装

```bash
pip install -r requirements.txt
```

### 2. 准备数据

确保您的sEMG数据为CSV格式，第2列（索引1）包含肌电信号值：

```csv
Time,EMG_Signal
0.000,0.001
0.001,0.002
0.002,-0.001
...
```

### 3. 基本使用流程

```python
from semg_preprocessing import *

# 配置参数
采样频率 = 1000.0  # Hz

# 1. 加载数据
信号, 数据框 = load_csv_data('你的数据.csv', value_column=1)

# 2. 带通滤波 (20-450 Hz)
滤波信号 = apply_bandpass_filter(信号, fs=采样频率, lowcut=20, highcut=450)

# 3. 去除工频干扰 (50 Hz及其谐波)
滤波信号 = apply_notch_filter(滤波信号, fs=采样频率, freq=50, harmonics=[1, 2, 3])

# 4. 检测肌肉活动
活动段 = detect_muscle_activity(滤波信号, fs=采样频率, method='combined')

# 5. 分段处理
分段结果 = segment_signal(滤波信号, 活动段, fs=采样频率)

# 6. 查看结果
for i, 段 in enumerate(分段结果):
    print(f"第{i+1}段: {段['start_time']:.3f}s - {段['end_time']:.3f}s")
    print(f"  持续时间: {段['duration']:.3f}s")
    print(f"  峰值幅度: {段['peak_amplitude']:.3f}")
```

## 详细功能说明

### 滤波功能

#### 1. 高通滤波
用于去除运动伪影、基线漂移和心电干扰（ECG）。

```python
# 基本用法
滤波后 = apply_highpass_filter(
    信号, 
    fs=1000,           # 采样频率
    cutoff=20,         # 截止频率 (推荐10-20Hz)
    order=4,           # 滤波器阶数 (推荐2-4)
    filter_type='butterworth'  # 'butterworth' 或 'chebyshev'
)

# 处理心电干扰时，可以提高截止频率
滤波后 = apply_highpass_filter(信号, fs=1000, cutoff=30, order=4)
```

#### 2. 低通滤波
用于去除高频噪声。

```python
滤波后 = apply_lowpass_filter(
    信号,
    fs=1000,
    cutoff=450,        # 截止频率 (推荐450-500Hz)
    order=4
)
```

#### 3. 带通滤波
结合高通和低通滤波，推荐使用。

```python
滤波后 = apply_bandpass_filter(
    信号,
    fs=1000,
    lowcut=20,         # 高通截止频率
    highcut=450,       # 低通截止频率
    order=4
)
```

#### 4. 工频干扰去除

**方案一：陷波滤波器**

```python
# 去除50Hz工频及其谐波
滤波后 = apply_notch_filter(
    信号,
    fs=1000,
    freq=50,                # 工频频率 (欧洲/亚洲: 50Hz, 美洲: 60Hz)
    quality_factor=30,      # 品质因数
    harmonics=[1, 2, 3]     # 谐波: 50Hz, 100Hz, 150Hz
)

# 北美地区使用60Hz
滤波后 = apply_notch_filter(信号, fs=1000, freq=60, harmonics=[1, 2])
```

**方案二：DFT方法**

```python
# 使用DFT去除工频干扰
滤波后 = remove_powerline_dft(
    信号,
    fs=1000,
    freq=50,
    harmonics=[1, 2, 3],
    bandwidth=1.0           # 频带宽度
)
```

### 肌肉活动检测

#### 方法选择

1. **'ruptures'** - 仅使用ruptures变化点检测
2. **'amplitude'** - 仅使用幅值阈值检测
3. **'combined'** - 结合两种方法（推荐）

```python
# 推荐：组合方法
活动段 = detect_muscle_activity(
    滤波信号,
    fs=1000,
    method='combined',          # 检测方法
    amplitude_threshold=None,   # 自动计算阈值（或手动设置）
    min_duration=0.1,          # 最小持续时间（秒）
    pen=3                      # ruptures惩罚参数（越高检测越少）
)

# 仅幅值检测（更快）
活动段 = detect_muscle_activity(
    滤波信号,
    fs=1000,
    method='amplitude',
    amplitude_threshold=0.5,    # 手动设置阈值
    min_duration=0.1
)
```

#### 参数调整建议

- **amplitude_threshold**: 阈值越高，检测到的活动段越少
- **min_duration**: 过滤掉太短的活动段
- **pen** (ruptures): 值越大，检测的变化点越少

### 信号分段

```python
分段结果 = segment_signal(
    滤波信号,
    活动段,
    fs=1000,
    include_metadata=True      # 包含元数据（持续时间、峰值等）
)

# 访问每个分段
for 段 in 分段结果:
    信号片段 = 段['data']          # 信号数据
    开始索引 = 段['start_index']   # 开始索引
    结束索引 = 段['end_index']     # 结束索引
    开始时间 = 段['start_time']    # 开始时间（秒）
    结束时间 = 段['end_time']      # 结束时间（秒）
    持续时间 = 段['duration']      # 持续时间（秒）
    峰值幅度 = 段['peak_amplitude'] # 峰值幅度
    平均幅度 = 段['mean_amplitude'] # 平均幅度
    均方根值 = 段['rms']           # RMS值
```

### 数据保存

```python
# 保存处理后的数据
save_processed_data(
    '处理后的数据.csv',
    滤波信号,
    fs=1000,
    include_time=True
)
```

## 完整示例

参见 `examples/` 目录：

1. `complete_pipeline.py` - 完整的预处理流程
2. `compare_filters.py` - 比较不同滤波方法
3. `detect_activity.py` - 肌肉活动检测对比

运行示例：

```bash
cd examples
python complete_pipeline.py
```

## 常见问题

### 1. 如何选择滤波器参数？

- **高通截止频率**: 10-20Hz（去除心电干扰时可用20-30Hz）
- **低通截止频率**: 450-500Hz
- **滤波器阶数**: 2-4（更高阶可能导致失真）

### 2. 检测不到肌肉活动怎么办？

- 降低 `amplitude_threshold`
- 减小 `pen` 参数（ruptures）
- 减小 `min_duration`
- 检查信号是否正确滤波

### 3. 检测到太多误报怎么办？

- 提高 `amplitude_threshold`
- 增大 `pen` 参数
- 增大 `min_duration`
- 使用 'combined' 方法

### 4. 如何处理不同采样频率的数据？

```python
from semg_preprocessing.utils import resample_signal

# 重采样到目标频率
新信号 = resample_signal(原信号, original_fs=2000, target_fs=1000)
```

## 技术支持

如有问题，请在GitHub上提交Issue：
https://github.com/PRIMOCOSMOS/sEMG-pre-processing/issues
